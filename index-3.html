<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Szenenanalyse-Coach ‚Äì Ill beim Polizisten (D√ºrrenmatt)</title>
  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --line: rgba(255,255,255,.12);
      --accent: #8bd3ff;
      --good: #9cffc6;
      --warn: #ffd38b;
      --bad: #ff9aa2;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
      --sidebarW: 420px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(139,211,255,.18), transparent 55%),
                  radial-gradient(900px 700px at 80% 10%, rgba(156,255,198,.10), transparent 50%),
                  radial-gradient(1200px 900px at 50% 100%, rgba(255,211,139,.10), transparent 60%),
                  var(--bg);
      color: var(--text);
      line-height: 1.5;
    }
    header{
      padding: 22px 18px 10px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      gap: 14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{
      font-size: clamp(1.25rem, 1.1rem + 1.4vw, 2rem);
      margin: 0;
      letter-spacing: .2px;
    }
    .subtitle{
      margin: 8px 0 0;
      color: var(--muted);
      max-width: 80ch;
    }
    .pillrow{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 14px;
    }
    .pill{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .9rem;
      color: var(--muted);
    }

    /* LAYOUT */
    main.layout{
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 18px 42px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      main.layout{grid-template-columns: 1fr}
    }

    .card{
      border: 1px solid var(--line);
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card header{
      padding: 16px 16px 10px;
      max-width:none;
    }
    .card h2{
      margin:0;
      font-size: 1.05rem;
    }
    .card p{
      margin: 8px 0 0;
      color: var(--muted);
      font-size: .95rem;
    }
    .card .content{
      padding: 0 16px 16px;
    }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
      align-items:center;
    }
    button, .btn{
      appearance:none;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .06s ease, background .2s ease, border-color .2s ease, opacity .2s ease;
      font-size: .92rem;
    }
    button:hover{background: rgba(255,255,255,.10)}
    button:active{transform: translateY(1px)}
    button:disabled{opacity:.45; cursor:not-allowed}
    .btn-accent{
      border-color: rgba(139,211,255,.35);
      background: rgba(139,211,255,.12);
    }
    .btn-accent:hover{background: rgba(139,211,255,.18)}
    .btn-good{
      border-color: rgba(156,255,198,.35);
      background: rgba(156,255,198,.12);
    }
    .btn-warn{
      border-color: rgba(255,211,139,.35);
      background: rgba(255,211,139,.10);
    }

    .input, textarea, select{
      width:100%;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline:none;
      font-family: var(--sans);
      font-size: .95rem;
    }

    /* BIG TEXTAREA */
    textarea#text{
      min-height: 560px;
      resize: vertical;
      font-size: 1rem;
      line-height: 1.6;
    }

    .small{
      font-size:.88rem;
      color: var(--muted);
    }

    .hr{
      height:1px; background: rgba(255,255,255,.10);
      margin: 14px 0;
    }
    .notice{
      border: 1px solid rgba(255,211,139,.30);
      background: rgba(255,211,139,.10);
      border-radius: 14px;
      padding: 10px;
      color: rgba(255,255,255,.86);
    }
    .notice strong{color: var(--warn)}
    .hidden{display:none !important;}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 680px){
      .grid2{grid-template-columns: 1fr}
    }

    .panel{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px;
    }

    /* TABS */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .tabbtn{
      padding: 8px 10px;
      border-radius: 999px;
      font-size: .92rem;
    }
    .tabbtn.active{
      border-color: rgba(139,211,255,.45);
      background: rgba(139,211,255,.16);
    }

    /* KPI */
    .kpi{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }
    .kpi .box{
      flex:1;
      min-width: 170px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px;
    }
    .kpi .label{color: var(--muted); font-size: .85rem}
    .kpi .value{font-family: var(--mono); margin-top: 6px; font-size: .95rem; color: rgba(255,255,255,.88)}

    /* Evidence */
    .evidence-list{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .evidence-card{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px;
    }
    .evidence-top{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
    }
    .evidence-top .name{
      font-family: var(--mono);
      font-size: .92rem;
      color: rgba(255,255,255,.86);
    }
    .evidence-fields{
      display:grid;
      gap: 8px;
      margin-top: 8px;
    }
    .evidence-fields label{
      font-size: .84rem;
      color: var(--muted);
      display:block;
      margin-bottom: 4px;
    }
    .evidence-fields textarea{
      min-height: 90px;
    }

    /* Rubric */
    .rubric{
      display:grid;
      gap: 10px;
    }
    .rubric-row{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px;
    }
    .rubric-head{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:flex-start;
    }
    .rubric-title{font-weight: 750}
    .rubric-help{color: var(--muted); font-size: .86rem; margin-top: 4px}
    .scorebox{
      display:flex;
      gap: 6px;
      align-items:center;
      flex-wrap:wrap;
    }
    .scorebtn{
      padding: 6px 10px;
      border-radius: 999px;
      font-family: var(--mono);
      font-size: .9rem;
    }
    .scorebtn.selected{
      border-color: rgba(139,211,255,.45);
      background: rgba(139,211,255,.16);
    }
    .rubric-tip{
      margin-top: 8px;
      color: rgba(255,255,255,.86);
      font-size: .92rem;
    }

    /* Sidebar (existing features, now toggle) */
    .sidebar{
      transition: transform .22s ease, opacity .22s ease;
    }
    body.sidebar-collapsed .sidebar{
      display:none;
    }

    /* Mobile slide-over sidebar */
    @media (max-width: 980px){
      body.sidebar-open .sidebar{
        display:block;
        position:fixed;
        top:0;
        right:0;
        height:100vh;
        width:min(var(--sidebarW), 92vw);
        z-index: 9000;
        transform: translateX(0);
        opacity: 1;
        border-radius: 0;
      }
      body:not(.sidebar-open) .sidebar{
        display:none;
      }
      .sidebar-backdrop{
        position:fixed;
        inset:0;
        background: rgba(0,0,0,.55);
        backdrop-filter: blur(6px);
        z-index: 8999;
        display:none;
      }
      body.sidebar-open .sidebar-backdrop{
        display:block;
      }
    }

    /* Sidebar contents */
    details{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.04);
      overflow:hidden;
    }
    details + details{margin-top: 10px;}
    summary{
      list-style:none;
      cursor:pointer;
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      user-select:none;
      font-weight: 650;
    }
    summary::-webkit-details-marker{display:none}
    .chev{
      width: 10px; height: 10px;
      border-right: 2px solid var(--muted);
      border-bottom: 2px solid var(--muted);
      transform: rotate(-45deg);
      transition: transform .2s ease;
      margin-left: auto;
    }
    details[open] .chev{transform: rotate(45deg)}
    .details-body{
      padding: 0 12px 12px;
      color: var(--muted);
      border-top: 1px solid rgba(255,255,255,.08);
    }
    .tag{
      display:inline-block;
      font-size: .8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      color: var(--muted);
      background: rgba(255,255,255,.03);
      margin-right: 6px;
      margin-top: 6px;
    }
    .snippet{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.24);
      border-radius: 14px;
      padding: 10px;
      font-family: var(--mono);
      font-size: .9rem;
      color: rgba(255,255,255,.86);
      white-space: pre-wrap;
    }
    .snippet-actions{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 8px;
    }

    .footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 30px;
      color: var(--muted);
      font-size:.9rem;
    }
          /* ========== Fokus-Modus ========== */
    body.focus-mode header,
    body.focus-mode .footer,
    body.focus-mode .tabs,
    body.focus-mode #tabEvidenceBtn,
    body.focus-mode #tabCheckBtn,
    body.focus-mode #tabEvidence,
    body.focus-mode #tabCheck,
    body.focus-mode .sidebar,
    body.focus-mode .sidebar-backdrop,
    body.focus-mode #liveCoachTips,
    body.focus-mode #tabWrite .panel,
    body.focus-mode .grid2:first-of-type{
      display:none !important;
    }

    /* Workspace nimmt volle Breite */
    body.focus-mode main.layout{
      grid-template-columns: 1fr !important;
      max-width: 1100px;
    }

    /* Schreibfl√§che maximal */
    body.focus-mode textarea#text{
      min-height: 75vh;
      max-height: 85vh;
    }

    /* Kleine Fokus-Toolbar (oben fix) */
    .focusbar{
      position: fixed;
      top: 12px;
      right: 12px;
      z-index: 10000;
      display: none;
      gap: 10px;
      align-items: center;
    }
    body.focus-mode .focusbar{
      display: flex;
    }
    .focusbar .pill{
      background: rgba(0,0,0,.35);
  }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div>
      <h1>Szenenanalyse-Coach: Ill beim Polizisten (D√ºrrenmatt)</h1>
      <p class="subtitle">
        √úbersichtlich durch Tabs: <strong>Schreiben</strong> (gro√üer Editor), <strong>Belege</strong> (Karten),
        <strong>Check</strong> (Wizard + Rubrik + Hinweise). Tipps rechts sind per Button ein-/ausblendbar.
      </p>
      <div class="pillrow">
        <span class="pill">Themen: Moralverfall ‚Ä¢ Korruption ‚Ä¢ Institutionenversagen</span>
        <span class="pill">Motive: gelbe Schuhe ‚Ä¢ Radio ‚Ä¢ Gewehr ‚Ä¢ Panther/Jagd ‚Ä¢ Goldzahn</span>
      </div>
    </div>

    <div class="controls" aria-label="Schnellaktionen">
      <button class="btn-accent" id="toggleSidebar" aria-expanded="false">Tipps √∂ffnen</button>
      <button id="toggleFocus" class="btn-warn" aria-pressed="false">Fokus-Modus</button>
      <button class="btn-good" id="saveNow">Speichern</button>
      <button class="btn-warn" id="resetAll">Zur√ºcksetzen</button>
    </div>
  </div>
</header>

<main class="layout">
  <!-- LEFT: Workspace -->
  <section class="card" aria-labelledby="workspaceTitle">
    <header>
      <h2 id="workspaceTitle">Arbeitsbereich</h2>
      <p>W√§hle links deinen Arbeitsmodus (Tabs). Rechts: Tipps nur bei Bedarf √∂ffnen.</p>

      <div class="grid2" style="margin-top:10px;">
        <div>
          <label class="small" for="mode">Modus</label>
          <select id="mode" class="input" style="margin-top:6px;">
            <option value="analysis">Szenenanalyse (ausformuliert)</option>
            <option value="summary">Kurze Inhaltsangabe (5‚Äì7 S√§tze)</option>
            <option value="thesis">Deutung/These + Belege</option>
          </select>
        </div>
        <div>
          <label class="small" for="support">Unterst√ºtzung</label>
          <select id="support" class="input" style="margin-top:6px;">
            <option value="high">hoch</option>
            <option value="mid" selected>mittel</option>
            <option value="low">niedrig</option>
          </select>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Arbeits-Tabs">
        <button class="tabbtn active" id="tabWriteBtn" data-tab="write" role="tab" aria-selected="true">Schreiben</button>
        <button class="tabbtn" id="tabEvidenceBtn" data-tab="evidence" role="tab" aria-selected="false">Belege</button>
        <button class="tabbtn" id="tabCheckBtn" data-tab="check" role="tab" aria-selected="false">Check</button>
      </div>
    </header>

    <div class="content">
      <!-- TAB: WRITE -->
      <div id="tabWrite" role="tabpanel">
        <div style="margin-top:12px;">
          <label class="small" for="text">Dein Text</label>
          <textarea id="text" placeholder="Schreibe hier‚Ä¶ (Tipp: √ñffne rechts nur bei Bedarf die Tipps.)" spellcheck="true" lang="de"></textarea>
        </div>

        <div class="controls" style="margin-top:10px;">
          <button class="btn-accent" id="copyText">Text kopieren</button>
          <button id="clearText">Leeren</button>
          <button class="btn-good" id="fillTemplate">Vorlage einf√ºgen</button>
        </div>

        <div class="hr"></div>

        <div class="panel">
          <div class="small">Kurzstatus</div>
          <div class="kpi" aria-label="Live-KPIs">
            <div class="box">
              <div class="label">Satzanzahl</div>
              <div class="value" id="sentCount">‚Äî</div>
            </div>
            <div class="box">
              <div class="label">Analyse-Anteil</div>
              <div class="value" id="analysisMeter">‚Äî</div>
            </div>
            <div class="box">
              <div class="label">Belege</div>
              <div class="value" id="evidenceMeter">‚Äî</div>
            </div>
          </div>
          <div id="liveCoachTips" class="notice hidden" style="margin-top:10px;"></div>
        </div>
      </div>

      <!-- TAB: EVIDENCE -->
      <div id="tabEvidence" class="hidden" role="tabpanel">
        <div class="panel" style="margin-top:12px;">
          <div class="controls" style="margin:0;">
            <div>
              <div style="font-weight:750">Belegkarten (Beleg ‚Üí Deutung ‚Üí Wirkung)</div>
              <div class="small">Erstelle 2‚Äì3 Karten. Du kannst daraus Abs√§tze bauen.</div>
            </div>
            <button class="btn-good" id="addEvidence" style="margin-left:auto;">+ Belegkarte</button>
          </div>
          <div class="evidence-list" id="evidenceList"></div>
          <div class="small" style="margin-top:10px;">
            Tipp: Eine Regieanweisung z√§hlt als Beleg (z.B. ‚Äûtrinkt Bier‚Äú, ‚Äûl√§dt das Gewehr‚Äú).
          </div>
        </div>
      </div>

      <!-- TAB: CHECK -->
      <div id="tabCheck" class="hidden" role="tabpanel">
        <div class="panel" style="margin-top:12px;">
          <div style="font-weight:750">Wizard (Schritt-f√ºr-Schritt)</div>
          <div class="small">Der Wizard hilft dir, strukturiert zu bleiben. Er sitzt bewusst im ‚ÄûCheck‚Äú-Tab.</div>

          <div class="hr"></div>

          <div class="grid2">
            <div class="panel">
              <div class="small">Leitfragen (aktueller Schritt)</div>
              <div id="stepPrompts" style="margin-top:8px; color: rgba(255,255,255,.88)"></div>
              <div class="hr"></div>
              <div class="controls" style="margin-top:0;">
                <button id="prevStep">‚Üê Zur√ºck</button>
                <button class="btn-accent" id="nextStep" style="margin-left:auto;">Weiter ‚Üí</button>
              </div>
              <div class="small" style="margin-top:8px;" id="stepGateHint"></div>
            </div>

            <div class="panel">
              <div class="small">Rubrik-Check (Selbsteinsch√§tzung)</div>
              <div class="small">0‚Äì2 Punkte pro Kriterium.</div>
              <div class="hr"></div>
              <div class="rubric" id="rubric"></div>
              <div class="hr"></div>
              <div class="controls" style="margin-top:0;">
                <div class="pill" id="rubricTotal">0 / 10</div>
                <div class="pill" id="rubricLevel">‚Äî</div>
                <button id="runCheck" style="margin-left:auto;">Hinweise aktualisieren</button>
              </div>
              <div id="rubricAdvice" class="notice hidden" style="margin-top:10px;"></div>
            </div>
          </div>

          <div id="checkDetails" class="notice hidden" style="margin-top:12px;"></div>
        </div>
      </div>
    </div>
  </section>

  <!-- RIGHT: Tips -->
  <aside class="card sidebar" aria-labelledby="tipsTitle">
    <header>
      <h2 id="tipsTitle">Tipps, Bausteine & Beispiele</h2>
      <p>Suche, klappe auf, nutze Bausteine.</p>
    </header>

    <div class="content">
      <div class="grid2" style="margin-bottom:10px;">
        <div>
          <label class="small" for="search">Bausteine durchsuchen</label>
          <input id="search" class="input" placeholder="z.B. 'Institutionen', 'Symbol', 'Ironie', 'Panther'‚Ä¶" />
        </div>
        <div>
          <label class="small" for="snippetMode">Baustein-Nutzung</label>
          <select id="snippetMode" class="input">
            <option value="rewrite" selected>Eigenst√§ndig (Umformulieren Pflicht)</option>
            <option value="free">Frei (direkt einf√ºgen)</option>
          </select>
        </div>
      </div>

      <details data-topic="struktur aufbau gliederung einleitung einordnung inhalt analyse deutung schluss" open>
        <summary>Struktur: 4-Schritt-Mini-Plan <span class="chev"></span></summary>
        <div class="details-body">
          <div class="tag">Schritt 1</div><div class="tag">Schritt 2</div><div class="tag">Schritt 3</div><div class="tag">Schritt 4</div>
          <div class="snippet" data-snippet>
1) Einordnung: Autor/Titel/Drama + Akt/Ort + Situation davor (Claires Angebot).
2) Inhaltskern: 2‚Äì4 Sinnabschnitte + Wendepunkt (Gewehr/‚ÄûJagd‚Äú-Motiv).
3) Analyse: Beleg ‚Üí Deutung ‚Üí Wirkung (Figuren, Gespr√§chsf√ºhrung, Symbole).
4) Deutung: Aussage der Szene + Funktion im Drama (Institutionenversagen, K√§uflichkeit, kollektive Schuld).
          </div>
          <div class="snippet-actions">
            <button data-insert="snippet">In Text einf√ºgen</button>
            <button data-copy="snippet">Kopieren</button>
          </div>
        </div>
      </details>

      <details data-topic="einleitung einordnung formulierungen kontext">
        <summary>Einordnung: Formulierungsbaustein <span class="chev"></span></summary>
        <div class="details-body">
          <div class="snippet" data-snippet>
Die Szene stammt aus dem zweiten Akt von Friedrich D√ºrrenmatts Tragikom√∂die ‚ÄûDer Besuch der alten Dame‚Äú und spielt im Polizeiposten von G√ºllen. Ill sucht Schutz, nachdem Claire Zachanassian der Stadt eine Milliarde versprochen hat, falls die B√ºrger ihn t√∂ten. In der Szene wird sichtbar, wie selbst die Institution Polizei vom moralischen Verfall erfasst wird.
          </div>
          <div class="snippet-actions">
            <button data-insert="snippet">Einf√ºgen</button>
            <button data-copy="snippet">Kopieren</button>
          </div>
        </div>
      </details>

      <details data-topic="analyse belege deutung wirkung">
        <summary>Analyse-Ger√ºst: Beleg ‚Üí Deutung ‚Üí Wirkung <span class="chev"></span></summary>
        <div class="details-body">
          <div class="snippet" data-snippet>
Beleg: ‚Äû‚Ä¶‚Äú / Regie: (‚Ä¶)
Deutung: Das zeigt, dass ‚Ä¶
Wirkung/Funktion: Auf den Zuschauer wirkt das ‚Ä¶, weil ‚Ä¶ / Dadurch entlarvt D√ºrrenmatt ‚Ä¶
          </div>
          <div class="snippet-actions">
            <button data-insert="snippet">Einf√ºgen</button>
            <button data-copy="snippet">Kopieren</button>
          </div>
        </div>
      </details>

      <details data-topic="symbole motive gelbe schuhe radio gewehr panther goldzahn">
        <summary>Symbole & Motive: Kurzdeutungen <span class="chev"></span></summary>
        <div class="details-body">
          <div class="snippet" data-snippet>
Gelbe Schuhe: sichtbarer Wohlstand auf Kredit ‚Üí moralischer Preis wird akzeptiert.
Radio/Operette: Normalisierung des Ungeheuerlichen ‚Üí K√§lte/Kontrast.
Goldzahn: Korruption/K√§uflichkeit.
Gewehr: Schutz wird Bedrohung ‚Üí Institutionenversagen.
Panther/Jagd: Ill als Beute ‚Üí kollektive Mechanik der Ausgrenzung.
          </div>
          <div class="snippet-actions">
            <button data-insert="snippet">Einf√ºgen</button>
            <button data-copy="snippet">Kopieren</button>
          </div>
        </div>
      </details>
    </div>
  </aside>
</main>

<div class="sidebar-backdrop" id="sidebarBackdrop" aria-hidden="true"></div>

<div class="footer">
  <p>Hinweis: Autosave speichert lokal im Browser. Es werden keine Daten gesendet.</p>
</div>
<div class="focusbar" id="focusbar" aria-label="Fokusleiste">
  <span class="pill" id="focusStatus">Fokus aktiv</span>
  <button class="btn-accent" id="exitFocus">Fokus beenden (Esc)</button>
</div>
<script>
  const $ = (sel, el=document) => el.querySelector(sel);
  const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

  const STORAGE_KEY = "szenenanalyse_coach_v2_tabs";

  const textArea = $("#text");
  const modeSel  = $("#mode");
  const supportSel = $("#support");
  const snippetModeSel = $("#snippetMode");

  // Tabs
  const tabButtons = $$(".tabbtn");
  const tabs = {
    write: $("#tabWrite"),
    evidence: $("#tabEvidence"),
    check: $("#tabCheck")
  };
  function setTab(name){
    Object.entries(tabs).forEach(([k, el])=>{
      el.classList.toggle("hidden", k !== name);
    });
    tabButtons.forEach(b=>{
      const active = b.getAttribute("data-tab") === name;
      b.classList.toggle("active", active);
      b.setAttribute("aria-selected", String(active));
    });
    saveStateDebounced();
  }
  tabButtons.forEach(b=>{
    b.addEventListener("click", ()=> setTab(b.getAttribute("data-tab")));
  });

  // Sidebar toggle
  const toggleSidebarBtn = $("#toggleSidebar");
  const sidebarBackdrop = $("#sidebarBackdrop");
  function isMobile(){ return window.matchMedia("(max-width: 980px)").matches; }
  function setSidebarState({ openMobile=null, collapsedDesktop=null } = {}){
    if (isMobile()){
      if (openMobile === null) openMobile = document.body.classList.contains("sidebar-open");
      document.body.classList.toggle("sidebar-open", !!openMobile);
      toggleSidebarBtn.setAttribute("aria-expanded", String(!!openMobile));
      toggleSidebarBtn.textContent = openMobile ? "Tipps schlie√üen" : "Tipps √∂ffnen";
    } else {
      if (collapsedDesktop === null) collapsedDesktop = document.body.classList.contains("sidebar-collapsed");
      document.body.classList.toggle("sidebar-collapsed", !!collapsedDesktop);
      const isCollapsed = document.body.classList.contains("sidebar-collapsed");
      toggleSidebarBtn.setAttribute("aria-expanded", String(!isCollapsed));
      toggleSidebarBtn.textContent = isCollapsed ? "Tipps √∂ffnen" : "Tipps schlie√üen";
    }
    saveStateDebounced();
  }
  toggleSidebarBtn.addEventListener("click", ()=>{
    if (isMobile()){
      setSidebarState({ openMobile: !document.body.classList.contains("sidebar-open") });
    } else {
      setSidebarState({ collapsedDesktop: !document.body.classList.contains("sidebar-collapsed") });
    }
  });
  sidebarBackdrop.addEventListener("click", ()=> setSidebarState({ openMobile:false }));
  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && document.body.classList.contains("sidebar-open")){
      setSidebarState({ openMobile:false });
    }
  });
  window.addEventListener("resize", ()=>{
    if (!isMobile()) document.body.classList.remove("sidebar-open");
    setSidebarState();
  });

  // Toast
  const t = document.createElement("div");
  t.style.position="fixed";
  t.style.left="50%";
  t.style.bottom="18px";
  t.style.transform="translateX(-50%)";
  t.style.padding="10px 12px";
  t.style.border="1px solid rgba(255,255,255,.18)";
  t.style.borderRadius="12px";
  t.style.background="rgba(0,0,0,.5)";
  t.style.color="rgba(255,255,255,.9)";
  t.style.backdropFilter="blur(8px)";
  t.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
  t.style.fontSize=".92rem";
  t.style.opacity="0";
  t.style.pointerEvents="none";
  t.style.transition="opacity .2s ease";
  document.body.appendChild(t);
  let toastTimer=null;
  function toast(msg){
    t.textContent = msg;
    t.style.opacity="1";
    clearTimeout(toastTimer);
    toastTimer = setTimeout(()=> t.style.opacity="0", 1200);
  }

  // Auto-grow textarea (more space while typing)
  function autoGrow(el){
    el.style.height = "auto";
    el.style.height = Math.min(el.scrollHeight, 980) + "px";
  }

  // Insert/copy
  function insertAtCursor(text){
    const start = textArea.selectionStart ?? textArea.value.length;
    const end   = textArea.selectionEnd ?? textArea.value.length;
    const before = textArea.value.slice(0, start);
    const after  = textArea.value.slice(end);
    const needsNL = before && !before.endsWith("\n") ? "\n\n" : "";
    const needsNLEnd = after && !after.startsWith("\n") ? "\n\n" : "\n\n";
    textArea.value = before + needsNL + text + needsNLEnd + after;
    const pos = (before + needsNL + text + "\n\n").length;
    textArea.focus();
    textArea.setSelectionRange(pos, pos);
    autoGrow(textArea);
    updateLiveCoach();
    saveStateDebounced();
  }

  function copyToClipboard(str){
    navigator.clipboard.writeText(str).then(()=> toast("Kopiert ‚úÖ"))
      .catch(()=>{
        const tmp = document.createElement("textarea");
        tmp.value = str;
        document.body.appendChild(tmp);
        tmp.select();
        document.execCommand("copy");
        tmp.remove();
        toast("Kopiert ‚úÖ");
      });
  }

  function getSnippet(btn){
    const actions = btn.closest(".snippet-actions");
    if (actions){
      const prev = actions.previousElementSibling;
      if (prev && prev.classList.contains("snippet")) return prev.innerText.trim();
    }
    const wrap = btn.closest(".details-body") || btn.closest("details") || document;
    const s = wrap.querySelector(".snippet");
    return s ? s.innerText.trim() : "";
  }

  // Snippet buttons
  $$("button[data-insert]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const snip = getSnippet(btn);
      if(!snip) return;
      if (snippetModeSel.value === "free"){
        insertAtCursor(snip);
        toast("Eingef√ºgt ‚úçÔ∏è");
      } else {
        // light-weight ‚Äúrewrite gate‚Äù: just open a prompt
        const rewritten = prompt("Schreibe den Baustein in eigenen Worten (1‚Äì2 S√§tze):", "");
        if (!rewritten || rewritten.trim().length < 25){
          toast("Umformulierung zu kurz");
          return;
        }
        insertAtCursor(rewritten.trim());
        toast("Eingef√ºgt ‚úçÔ∏è");
      }
    });
  });
  $$("button[data-copy]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const snip = getSnippet(btn);
      if(!snip) return;
      copyToClipboard(snip);
    });
  });

  // Search filter
  $("#search").addEventListener("input", (e)=>{
    const q = e.target.value.trim().toLowerCase();
    $$("details").forEach(d=>{
      const topic = (d.getAttribute("data-topic") || "").toLowerCase();
      const text = d.innerText.toLowerCase();
      const hit = !q || topic.includes(q) || text.includes(q);
      d.classList.toggle("hidden", !hit);
    });
  });

  // Templates
  const templates = {
    analysis:
`Schritt 1 ‚Äì Einordnung:
- Autor/Titel/Drama, Akt/Ort, Situation davor (Claires Angebot), Thema der Szene.

Schritt 2 ‚Äì Inhaltskern:
- 2‚Äì4 Sinnabschnitte (Ill fordert Hilfe ‚Üí Polizei weicht aus ‚Üí Zeichen der Korruption ‚Üí Wendepunkt/Gewehr).

Schritt 3 ‚Äì Analyse (Beleg ‚Üí Deutung ‚Üí Wirkung):
- Figuren / Gespr√§chsf√ºhrung / Symbole / Regie (mit Belegen).

Schritt 4 ‚Äì Deutung/Funktion:
- Aussage der Szene (Institutionenversagen, K√§uflichkeit, Moral als Fassade)
- Verbindung zum Drama (Ills Ausgrenzung, kollektive Schuld)`,
    summary:
`Schreibe 5‚Äì7 S√§tze:
1) Ill f√ºhlt sich bedroht und geht zur Polizei.
2) Er verlangt eine Anzeige/Verhaftung gegen Claire.
3) Der Polizist nimmt es nicht ernst und weicht aus.
4) Konsum/gelbe Schuhe zeigen: Stadt lebt auf Kredit.
5) Wendung: Gewehr/Jagd-Motiv bricht die Schutzbehauptung.
6) Ill erkennt die Mechanik und seine Ausgrenzung.`,
    thesis:
`These (1 Satz):
‚Üí ‚Ä¶

Begr√ºndung (2‚Äì3 Punkte, jeweils mit Beleg ‚Üí Deutung ‚Üí Wirkung):
1) Beleg: ‚Äû‚Ä¶‚Äú / Regie: (‚Ä¶)
   Deutung: ‚Ä¶
   Wirkung/Funktion: ‚Ä¶
2) ‚Ä¶
3) ‚Ä¶

Schluss (1‚Äì2 S√§tze):
‚Üí Aussage + Verbindung zum Drama (Moral, Geld, kollektive Schuld).`
  };

  $("#fillTemplate").addEventListener("click", ()=>{
    const key = modeSel.value;
    textArea.value = templates[key] + "\n";
    textArea.focus();
    autoGrow(textArea);
    toast("Vorlage eingef√ºgt üß©");
    updateLiveCoach();
    saveStateDebounced();
  });

  $("#copyText").addEventListener("click", ()=>{
    const val = textArea.value.trim();
    if(!val){ toast("Nichts zum Kopieren"); return; }
    copyToClipboard(val);
  });

  $("#clearText").addEventListener("click", ()=>{
    textArea.value = "";
    autoGrow(textArea);
    toast("Geleert");
    updateLiveCoach();
    saveStateDebounced();
  });

  // Evidence manager
  const evidenceListEl = $("#evidenceList");
  const addEvidenceBtn = $("#addEvidence");

  function newEvidenceCard(data){
    const id = data?.id || ("e" + Math.random().toString(36).slice(2,9));
    const card = document.createElement("div");
    card.className = "evidence-card";
    card.setAttribute("data-id", id);
    card.innerHTML = `
      <div class="evidence-top">
        <div class="name">Belegkarte ${id}</div>
        <div class="controls" style="margin:0;">
          <button class="scorebtn" data-build>Absatz bauen</button>
          <button class="scorebtn" data-del>L√∂schen</button>
        </div>
      </div>
      <div class="evidence-fields">
        <div>
          <label>Beleg (Zitat/Regieanweisung, kurz)</label>
          <input class="input" data-field="beleg" placeholder='z.B. ‚ÄûMerkw√ºrdig. √Ñu√üerst merkw√ºrdig.‚Äú / (trinkt Bier)' />
        </div>
        <div class="grid2">
          <div>
            <label>Deutung (Was bedeutet das?)</label>
            <textarea data-field="deutung" placeholder="z.B. Institution ist korrumpiert ‚Ä¶"></textarea>
          </div>
          <div>
            <label>Wirkung/Funktion (Wozu? Wirkung beim Zuschauer)</label>
            <textarea data-field="wirkung" placeholder="z.B. groteske Ironie, Entlarvung ‚Ä¶"></textarea>
          </div>
        </div>
      </div>
    `;
    if (data){
      card.querySelector('[data-field="beleg"]').value = data.beleg || "";
      card.querySelector('[data-field="deutung"]').value = data.deutung || "";
      card.querySelector('[data-field="wirkung"]').value = data.wirkung || "";
    }
    card.addEventListener("input", ()=> { saveStateDebounced(); updateLiveCoach(); });
    card.querySelector("[data-del]").addEventListener("click", ()=>{
      card.remove();
      toast("Belegkarte gel√∂scht");
      saveStateDebounced();
      updateLiveCoach();
    });
    card.querySelector("[data-build]").addEventListener("click", ()=>{
      const beleg = card.querySelector('[data-field="beleg"]').value.trim();
      const deut = card.querySelector('[data-field="deutung"]').value.trim();
      const wirk = card.querySelector('[data-field="wirkung"]').value.trim();
      if(!beleg || !deut || !wirk){ toast("Bitte Beleg + Deutung + Wirkung ausf√ºllen"); return; }
      insertAtCursor(`Beleg: ${beleg}\nDeutung: ${deut}\nWirkung/Funktion: ${wirk}`);
      toast("Absatz eingef√ºgt ‚úçÔ∏è");
      setTab("write");
    });
    return card;
  }

  addEvidenceBtn.addEventListener("click", ()=>{
    evidenceListEl.appendChild(newEvidenceCard());
    toast("Belegkarte hinzugef√ºgt");
    saveStateDebounced();
    updateLiveCoach();
  });

  // Wizard (moved to Check tab)
  let currentStep = 1;
  const stepPromptsEl = $("#stepPrompts");
  const stepGateHintEl = $("#stepGateHint");
  const prevStepBtn = $("#prevStep");
  const nextStepBtn = $("#nextStep");

  const stepPrompts = {
    analysis: {
      1: [
        "Nenne Autor, Titel, Textsorte (Drama), Akt/Ort.",
        "Was ist direkt davor passiert (Claires Angebot)?",
        "Thema der Szene in 1 Satz (z.B. ‚ÄûIll sucht Schutz, aber die Institution versagt‚Äú)."
      ],
      2: [
        "Gliedere in 2‚Äì4 Sinnabschnitte (wer tut was? was √§ndert sich?).",
        "Nenne die Wendung: Woran merkt Ill, dass er nicht gesch√ºtzt wird?"
      ],
      3: [
        "W√§hle 2 Analysefelder: Figuren / Gespr√§chsf√ºhrung / Symbole / Regie.",
        "Pro Absatz: Beleg ‚Üí Deutung ‚Üí Wirkung.",
        "Baue mind. 2 Motive ein (gelbe Schuhe, Radio, Gewehr, Panther, Goldzahn)."
      ],
      4: [
        "Welche Aussage kritisiert D√ºrrenmatt hier? (K√§uflichkeit/Institutionenversagen/Moral).",
        "Welche Funktion hat die Szene im Drama? (Wendepunkt, Vorbereitung der ‚ÄûJagd‚Äú)."
      ]
    },
    summary: {
      1: ["Starte mit Ausgangslage: Ill f√ºhlt sich bedroht und geht zur Polizei."],
      2: ["Forderung + Reaktion des Polizisten (1‚Äì2 S√§tze)."],
      3: ["Beobachtung (Konsum/gelbe Schuhe) + Wendung (Gewehr/Jagd)."],
      4: ["Schluss: Was erkennt Ill? Ziel: 5‚Äì7 S√§tze."]
    },
    thesis: {
      1: ["These in 1 Satz (keine Nacherz√§hlung)."],
      2: ["Plane 2‚Äì3 Begr√ºndungspunkte, jeder mit Beleg."],
      3: ["Schreibe je Punkt: Beleg ‚Üí Deutung ‚Üí Wirkung."],
      4: ["Schluss: Verbindung zum Drama (kollektive Schuld / Mechanik der Stadt)."]
    }
  };

  function renderStepPrompts(){
    const prompts = stepPrompts[modeSel.value][currentStep] || [];
    stepPromptsEl.innerHTML =
      "<ul style='margin:0; padding-left:18px;'>" +
      prompts.map(p=>`<li>${p}</li>`).join("") +
      "</ul>";
  }

  function countSentences(txt){
    return txt.replace(/\n+/g," ").split(/[.!?]+/g).map(s=>s.trim()).filter(Boolean).length;
  }
  function hasQuote(txt){
    return /‚Äû[^‚Äú]{1,120}‚Äú/.test(txt) || /"[^"]{1,120}"/.test(txt) || /\([^)]{0,60}(trinkt|l√§dt|z√ºndet)[^)]{0,60}\)/i.test(txt);
  }
  function getEvidenceCount(){
    return $$(".evidence-card", evidenceListEl).length;
  }

  function stepGateOk(){
    const txt = textArea.value.trim();
    const lc = txt.toLowerCase();
    const evCount = getEvidenceCount();
    const sc = countSentences(txt);

    if (modeSel.value === "summary"){
      if (currentStep === 4) return {ok: sc >= 5, hint:"Ziel: 5‚Äì7 S√§tze."};
      return {ok: sc >= currentStep, hint:"Schreibe pro Schritt mindestens ~1 Satz."};
    }

    if (modeSel.value === "analysis"){
      if (currentStep === 1) return {ok: /(d√ºrrenmat|besuch|akt|g√ºllen|polizei|polizist)/i.test(txt), hint:"Nenne Autor/Titel/Akt/Ort."};
      if (currentStep === 2) return {ok: sc >= 3, hint:"Schreibe einen kurzen Inhaltskern (mind. 3 S√§tze) oder Sinnabschnitte."};
      if (currentStep === 3){
        const hasSymbols = /(gelbe.*schuh|radio|gewehr|panther|goldzahn)/i.test(lc);
        const hasAnalysisVerb = /(zeigt|verdeutlicht|entlarvt|wirkung|funktion|symbol|iron)/i.test(lc);
        const hasEvidence = evCount >= 2 || hasQuote(txt);
        return {ok: hasSymbols && hasAnalysisVerb && hasEvidence, hint:"Schritt 3: Motive + Analysebegriffe + mind. 2 Belege."};
      }
      if (currentStep === 4) return {ok: /(k√§uflich|korrupt|moral|institution|kollektiv|schuld|kritik|aussage)/i.test(lc), hint:"Schritt 4: Aussage/Funktion klar formulieren."};
    }

    if (modeSel.value === "thesis"){
      if (currentStep === 1) return {ok: sc >= 1, hint:"Formuliere eine These (1 Satz)."};
      if (currentStep === 2) return {ok: evCount >= 1 || hasQuote(txt), hint:"Lege mind. 1 Beleg an."};
      if (currentStep === 3) return {ok: evCount >= 2 || /(beleg|deutung|wirkung)/i.test(lc), hint:"Schreibe Beleg ‚Üí Deutung ‚Üí Wirkung (mind. 2 Punkte)."};
      if (currentStep === 4) return {ok: /(insgesamt|folglich|somit|verbindung|schluss)/i.test(lc), hint:"Schluss mit Verbindung zum Drama."};
    }

    return {ok:true, hint:""};
  }

  function updateWizardUI(){
    prevStepBtn.disabled = currentStep === 1;
    nextStepBtn.textContent = currentStep === 4 ? "Fertig ‚úì" : "Weiter ‚Üí";
    renderStepPrompts();
    const res = stepGateOk();
    stepGateHintEl.textContent = res.ok ? "‚úì Schritt erf√ºllt ‚Äì weiter m√∂glich." : ("‚ú± " + res.hint);
    nextStepBtn.disabled = !res.ok && currentStep !== 1;
  }

  prevStepBtn.addEventListener("click", ()=>{
    currentStep = Math.max(1, currentStep - 1);
    updateWizardUI();
    saveStateDebounced();
  });
  nextStepBtn.addEventListener("click", ()=>{
    if (currentStep < 4){
      currentStep++;
      updateWizardUI();
      saveStateDebounced();
    } else {
      toast("Wizard abgeschlossen ‚úÖ");
      runAutoSuggestions();
    }
  });

  // Live coach
  const sentCountEl = $("#sentCount");
  const analysisMeterEl = $("#analysisMeter");
  const evidenceMeterEl = $("#evidenceMeter");
  const liveCoachTipsEl = $("#liveCoachTips");

  const analysisVerbs = ["zeigt","verdeutlicht","entlarvt","symbol","iron","grotesk","wirkung","funktion","kritik","kontrast","regie"];
  const storyMarkers = ["dann","danach","anschlie√üend","zun√§chst","sp√§ter","schlie√ülich","daraufhin","w√§hrenddessen"];

  function analysisMeter(txt){
    const lc = txt.toLowerCase();
    const a = analysisVerbs.reduce((acc,w)=> acc + (lc.includes(w) ? 1 : 0), 0);
    const s = storyMarkers.reduce((acc,w)=> acc + (lc.includes(w) ? 1 : 0), 0);
    if (!txt.trim()) return "‚Äî";
    if (a >= 5) return "hoch ‚úì";
    if (a >= 2) return "mittel";
    if (s >= 3) return "niedrig (viel Inhalt)";
    return "niedrig";
  }
  function countEvidenceInText(txt){
    let count = 0;
    count += (txt.match(/‚Äû[^‚Äú]{1,120}‚Äú/g) || []).length;
    count += (txt.match(/\([^)]{0,60}(trinkt|l√§dt|z√ºndet)[^)]{0,60}\)/ig) || []).length;
    return count;
  }

  function updateLiveCoach(){
    const txt = textArea.value;
    const sc = countSentences(txt);

    sentCountEl.textContent = modeSel.value === "summary" ? (sc + " (Ziel: 5‚Äì7)") : String(sc);
    analysisMeterEl.textContent = analysisMeter(txt);

    const totalEv = getEvidenceCount() + countEvidenceInText(txt);
    evidenceMeterEl.textContent = totalEv ? (totalEv + " (Ziel: ‚â• 2)") : "0 (Ziel: ‚â• 2)";

    const tips = [];
    if (modeSel.value === "summary"){
      if (sc < 5) tips.push("Inhaltsangabe ist noch zu kurz (Ziel: 5‚Äì7 S√§tze).");
      if (sc > 8) tips.push("K√ºrzen: auf 5‚Äì7 S√§tze konzentrieren (Wendepunkt behalten).");
    } else {
      if (!/(gelbe.*schuh|radio|gewehr|panther|goldzahn)/i.test(txt)) tips.push("Nenne Motive (gelbe Schuhe, Radio, Gewehr, Panther, Goldzahn).");
      if (!/(zeigt|verdeutlicht|entlarvt|wirkung|funktion|symbol|iron)/i.test(txt)) tips.push("Nutze Analysebegriffe (Symbolik, Ironie, Wirkung).");
      if (totalEv < 2) tips.push("Baue mind. 2 Belege ein (Zitat oder Regieanweisung).");
    }

    liveCoachTipsEl.classList.toggle("hidden", tips.length === 0);
    if (tips.length){
      liveCoachTipsEl.innerHTML =
        "<strong>Live-Tipps:</strong><ul style='margin:8px 0 0; padding-left:18px; color: rgba(255,255,255,.90)'>" +
        tips.map(t=>`<li>${t}</li>`).join("") + "</ul>";
    }

    updateWizardUI();
  }

  textArea.addEventListener("input", ()=>{
    autoGrow(textArea);
    updateLiveCoach();
    saveStateDebounced();
  });

  // Rubric
  const rubricEl = $("#rubric");
  const rubricTotalEl = $("#rubricTotal");
  const rubricLevelEl = $("#rubricLevel");
  const rubricAdviceEl = $("#rubricAdvice");
  const checkDetails = $("#checkDetails");

  const rubricConfig = [
    { key:"struktur", title:"Struktur", help:"Einordnung ‚Üí Inhalt ‚Üí Analyse ‚Üí Deutung?", tips:["Nutze klare Signalw√∂rter oder Zwischen√ºberschriften.","Fokus weg vom Erz√§hlen ‚Äì hin zur Analyse."] },
    { key:"belege", title:"Belege", help:"Mind. 2 Belege (auch Regie)?", tips:["F√ºge 1‚Äì2 kurze Zitate/Regieanweisungen ein.","Erkl√§re nach jedem Beleg die Bedeutung (Deutung)."] },
    { key:"tiefe", title:"Analyse-Tiefe", help:"Beleg ‚Üí Deutung ‚Üí Wirkung vorhanden?", tips:["Nutze Satzstarter: ‚ÄûDas zeigt‚Ä¶‚Äú, ‚ÄûDadurch entlarvt‚Ä¶‚Äú.","Erg√§nze Wirkung/Funktion (Wozu im Drama?)."] },
    { key:"begriffe", title:"Fachbegriffe", help:"Symbolik, Ironie/Groteske, Regie, Kontrast?", tips:["Benenne mindestens 2 Mittel (Symbol, Ironie, Regie).","Verbinde Mittel mit Wirkung."] },
    { key:"sprache", title:"Sprache & Klarheit", help:"Sachlich, pr√§zise, nicht zu lange S√§tze.", tips:["K√ºrze S√§tze √ºber ~30 W√∂rter.","Streiche F√ºllw√∂rter."] }
  ];
  const rubricScores = new Map();

  function renderRubric(){
    rubricEl.innerHTML = "";
    rubricConfig.forEach(item=>{
      rubricScores.set(item.key, rubricScores.get(item.key) ?? 0);
      const row = document.createElement("div");
      row.className = "rubric-row";
      row.innerHTML = `
        <div class="rubric-head">
          <div>
            <div class="rubric-title">${item.title}</div>
            <div class="rubric-help">${item.help}</div>
          </div>
          <div class="scorebox" data-scorebox>
            <button class="scorebtn" data-score="0">0</button>
            <button class="scorebtn" data-score="1">1</button>
            <button class="scorebtn" data-score="2">2</button>
          </div>
        </div>
        <div class="rubric-tip" data-tip></div>
      `;
      const box = row.querySelector("[data-scorebox]");
      const tip = row.querySelector("[data-tip]");

      function setSelected(score){
        rubricScores.set(item.key, score);
        box.querySelectorAll("button").forEach(b=>{
          b.classList.toggle("selected", Number(b.getAttribute("data-score")) === score);
        });
        tip.innerHTML = score < 2
          ? `<strong>Tipp:</strong> ${item.tips[Math.min(score, item.tips.length-1)]}`
          : `<span style="color: rgba(156,255,198,.92)">Sieht gut aus ‚úì</span>`;
        updateRubricSummary();
        saveStateDebounced();
      }
      box.querySelectorAll("button").forEach(b=>{
        b.addEventListener("click", ()=> setSelected(Number(b.getAttribute("data-score"))));
      });
      setSelected(rubricScores.get(item.key));
      rubricEl.appendChild(row);
    });
  }

  function updateRubricSummary(){
    let total = 0;
    rubricConfig.forEach(i=> total += (rubricScores.get(i.key) ?? 0));
    rubricTotalEl.textContent = `${total} / 10`;
    let level = "‚Äî";
    if (total >= 9) level = "sehr stark";
    else if (total >= 7) level = "gut";
    else if (total >= 5) level = "okay";
    else level = "ausbauf√§hig";
    rubricLevelEl.textContent = level;

    const weak = rubricConfig
      .map(i=> ({key:i.key, score: rubricScores.get(i.key) ?? 0, item:i}))
      .filter(x=> x.score <= 1);

    rubricAdviceEl.classList.toggle("hidden", weak.length === 0);
    if (weak.length){
      rubricAdviceEl.innerHTML =
        "<strong>Fokus f√ºr die n√§chste √úberarbeitung:</strong><ul style='margin:8px 0 0; padding-left:18px; color: rgba(255,255,255,.90)'>" +
        weak.slice(0,3).map(w=>`<li><strong>${w.item.title}:</strong> ${w.item.tips[0]}</li>`).join("") +
        "</ul>";
    }
  }

  function runAutoSuggestions(){
    const txt = textArea.value;
    const lc = txt.toLowerCase();
    const tips = [];
    if(!/(gelbe.*schuh|radio|gewehr|panther|goldzahn)/i.test(lc)){
      tips.push("Baue 2‚Äì3 Motive ein (gelbe Schuhe, Radio, Gewehr, Panther, Goldzahn) und deute sie.");
    }
    if(!/(polizei|gesetz|pflicht|institution)/i.test(lc)){
      tips.push("Betone das Institutionenversagen (Polizei als Schutzbehauptung).");
    }
    if(!/(korrupt|k√§uflich|moral|gier|kollektiv|schuld)/i.test(lc)){
      tips.push("Sch√§rfe die Deutung (K√§uflichkeit, Moralverfall, kollektive Schuld).");
    }
    const filler = ["irgendwie", "halt", "total", "mega", "krass", "sozusagen"];
    if (filler.some(w=>lc.includes(w))) tips.push("Streiche F√ºllw√∂rter (irgendwie/halt/mega ‚Ä¶).");
    if (getEvidenceCount() + countEvidenceInText(txt) < 2) tips.push("F√ºge mind. 2 Belege ein (Zitat oder Regieanweisung).");

    checkDetails.classList.toggle("hidden", tips.length === 0);
    if (tips.length){
      checkDetails.innerHTML =
        "<strong>Verbesserungsvorschl√§ge:</strong><ul style='margin:8px 0 0; padding-left:18px; color: rgba(255,255,255,.90)'>" +
        tips.map(t=>`<li>${t}</li>`).join("") + "</ul>";
    }
  }

  $("#runCheck").addEventListener("click", ()=>{
    updateRubricSummary();
    runAutoSuggestions();
    toast("Hinweise aktualisiert ‚úÖ");
  });

  // Support level (simple: hide some details)
  function applySupportLevel(){
    const lvl = supportSel.value;
    const details = $$("aside details");
    details.forEach(d=> d.classList.remove("hidden"));
    if (lvl === "low"){
      details.forEach(d=>{
        const topic = (d.getAttribute("data-topic") || "");
        if (/beispiel|zusammenfassung/i.test(topic)) d.classList.add("hidden");
      });
    }
  }
  supportSel.addEventListener("change", ()=>{
    applySupportLevel();
    saveStateDebounced();
  });

  // Save/load
  function collectEvidence(){
    return $$(".evidence-card", evidenceListEl).map(card=>{
      const id = card.getAttribute("data-id");
      return {
        id,
        beleg: card.querySelector('[data-field="beleg"]').value,
        deutung: card.querySelector('[data-field="deutung"]').value,
        wirkung: card.querySelector('[data-field="wirkung"]').value
      };
    });
  }
  function readState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : null;
    }catch{ return null; }
  }
  function writeState(state){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  let saveTimer = null;
  function saveStateDebounced(){
    clearTimeout(saveTimer);
    saveTimer = setTimeout(saveState, 300);
  }
  function saveState(){
    const state = {
      mode: modeSel.value,
      support: supportSel.value,
      snippetMode: snippetModeSel.value,
      tab: Object.entries(tabs).find(([k, el]) => !el.classList.contains("hidden"))?.[0] || "write",
      currentStep,
      text: textArea.value,
      evidence: collectEvidence(),
      rubric: Object.fromEntries(Array.from(rubricScores.entries())),
      sidebarCollapsed: document.body.classList.contains("sidebar-collapsed"),
      sidebarOpen: document.body.classList.contains("sidebar-open")
    };
    writeState(state);
  }

  function loadState(){
    const state = readState();
    if (!state) return;

    modeSel.value = state.mode || "analysis";
    supportSel.value = state.support || "mid";
    snippetModeSel.value = state.snippetMode || "rewrite";
    currentStep = state.currentStep || 1;
    textArea.value = state.text || "";
    autoGrow(textArea);

    evidenceListEl.innerHTML = "";
    (state.evidence || []).forEach(ev=>{
      evidenceListEl.appendChild(newEvidenceCard(ev));
    });

    const r = state.rubric || {};
    rubricConfig.forEach(item=>{
      const v = Number(r[item.key]);
      if (!Number.isNaN(v)) rubricScores.set(item.key, Math.max(0, Math.min(2, v)));
    });

    renderRubric();
    applySupportLevel();

    setTab(state.tab || "write");

    // sidebar state will be applied after init; do not blindly open on mobile
    if (state.sidebarCollapsed) document.body.classList.add("sidebar-collapsed");
    if (state.sidebarOpen && isMobile()) document.body.classList.add("sidebar-open");
    
    if (state.focusMode){setFocusMode(true);} 
  }

  $("#saveNow").addEventListener("click", ()=>{
    saveState();
    toast("Gespeichert ‚úÖ");
  });

  $("#resetAll").addEventListener("click", ()=>{
    localStorage.removeItem(STORAGE_KEY);
    // reset UI
    modeSel.value = "analysis";
    supportSel.value = "mid";
    snippetModeSel.value = "rewrite";
    currentStep = 1;
    textArea.value = "";
    autoGrow(textArea);
    evidenceListEl.innerHTML = "";
    rubricScores.clear();
    renderRubric();
    applySupportLevel();
    setTab("write");
    checkDetails.classList.add("hidden");
    // default: sidebar closed
    document.body.classList.add("sidebar-collapsed");
    document.body.classList.remove("sidebar-open");
    setSidebarState({ collapsedDesktop:true, openMobile:false });
    updateLiveCoach();
    updateWizardUI();
    toast("Zur√ºckgesetzt");
  });

  modeSel.addEventListener("change", ()=>{
    // update placeholder lightly
    const placeholders = {
      analysis: "Schreibe deine Szenenanalyse‚Ä¶ (Einordnung ‚Üí Inhalt ‚Üí Analyse ‚Üí Deutung)",
      summary: "Schreibe 5‚Äì7 S√§tze Inhaltsangabe‚Ä¶",
      thesis: "Formuliere eine These und st√ºtze sie mit Belegen‚Ä¶"
    };
    textArea.placeholder = placeholders[modeSel.value];
    currentStep = 1;
    updateWizardUI();
    updateLiveCoach();
    saveStateDebounced();
  });

  // Init
  renderRubric();
  applySupportLevel();
  loadState();

  // Ensure at least one evidence card for non-summary (optional)
  if (evidenceListEl.children.length === 0 && modeSel.value !== "summary"){
    evidenceListEl.appendChild(newEvidenceCard({ id:"start" }));
  }

  // Default: sidebar closed (important for clarity)
  if (!isMobile()){
    document.body.classList.add("sidebar-collapsed");
  }
  setSidebarState({ collapsedDesktop: document.body.classList.contains("sidebar-collapsed"), openMobile:false });

  // initial updates
  autoGrow(textArea);
  updateWizardUI();
  updateLiveCoach();
      // ========== Fokus-Modus ==========
  const focusBtn = $("#toggleFocus");
  const exitFocusBtn = $("#exitFocus");
  const focusbar = $("#focusbar");

  function setFocusMode(on){
    document.body.classList.toggle("focus-mode", !!on);

    // Sidebar im Fokus immer zu
    document.body.classList.add("sidebar-collapsed");
    document.body.classList.remove("sidebar-open");
    setSidebarState({ collapsedDesktop:true, openMobile:false });

    // Im Fokus: Tab "write" erzwingen
    setTab("write");

    focusBtn.setAttribute("aria-pressed", String(!!on));
    focusBtn.textContent = on ? "Fokus beenden" : "Fokus-Modus";

    // optional: Textarea direkt fokussieren
    if (on){
      textArea.focus();
      autoGrow(textArea);
    }

    // speichern
    try{
      const s = readState() || {};
      s.focusMode = !!on;
      localStorage.setItem(STORAGE_KEY, JSON.stringify(s));
    }catch{}
  }

  focusBtn.addEventListener("click", ()=>{
    const isOn = document.body.classList.contains("focus-mode");
    setFocusMode(!isOn);
  });

  exitFocusBtn.addEventListener("click", ()=> setFocusMode(false));

  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && document.body.classList.contains("focus-mode")){
      setFocusMode(false);
    }
  });

</script>
</body>
</html>
